import numpy as np
from static import StaticTest
from iohandler import TestIOHandler
from ase import Atoms

def run_ice(number, env, ref=False):

  name = "IceXI"
  description = "Ice XI 8 molecules DZP diagonalisation"
  grid_cutoff = 80.0
  xc = "PBE"
  kpts = [9,9,9]
  basis = "medium"
  env.set_nprocs(4)

  cell = [4.137266, 7.298682, 6.740787]
  positions = [(0.00004235166920939, 0.52132867339661904, 0.01312804623422056),
               (0.00002422597654387, 0.66197026160406081, 0.21915381211889559),
               (0.00002811635854249, 0.47868217543515051, 0.51312960244626338),
               (0.00005632421000542, 0.33803483627959369, 0.71915539992719857),
               (0.50006428950131876, 0.16197109165777751, 0.21915594041982714),
               (0.50005083190497801, 0.02132700140357800, 0.01312812071049466),
               (0.50002880918180725, 0.83803779015457791, 0.71915331922284009),
               (0.50002715936536779, 0.97867748875666416, 0.51312809969130790),
               (0.29280958502426158, 0.75746687855426764, 0.98904730686645670),
               (0.70726827228582734, 0.75745492928010660, 0.98904450053802062),
               (0.29280268188327385, 0.24255842762989188, 0.48904040599159815),
               (0.70726690993963393, 0.24255384186864903, 0.48905272571304059),
               (0.20730246202883651, 0.25745862648053025, 0.98905082501075958),
               (0.79283945672356571, 0.25745578333197661, 0.98905090188310130),
               (0.20724870545567675, 0.74255081462513184, 0.48904100890172741),
               (0.79278388107700459, 0.74255422496356938, 0.48904173022674335),
               (0.00001782623484499, 0.65894809106556096, 0.06181159443008376),
               (0.00003361021850561, 0.34106276127523438, 0.56181309250277522),
               (0.50005855789217557, 0.15894559382014778, 0.06181332063013109),
               (0.50001707071609058, 0.84105732900959684, 0.56181020612117150),
               (0.50003416709071735, 0.82863413453639312, 0.93818224732333610),
               (0.50003324583385567, 0.17137873439506193, 0.43818522549074967),
               (0.00005961164496471, 0.32862823724067103, 0.93818694298206462),
               (0.00001192955904678, 0.67137526341019071, 0.43818338648467903)]

  ice = Atoms("H16O8", positions=positions)
  ice.set_cell(cell, scale_atoms=True)

  tester = StaticTest(number, name, description, ice, verbose=True)
  handler = TestIOHandler(tester, ref)
  handler.run_test(grid_cutoff, xc, kpts, basis)
